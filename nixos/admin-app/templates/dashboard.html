{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 py-6">

    {# ── Header ── #}
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <svg class="h-6 opacity-90" viewBox="0 0 496 148" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <title>Group 6</title>
                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="Desktop-HD" transform="translate(-68.000000, -665.000000)" fill-rule="nonzero">
                        <g id="Group-9" transform="translate(25.405063, 654.000000)">
                            <g id="Group-6" transform="translate(43.000000, 11.000000)">
                                <path d="M168.594937,119 L168.594937,99.05 L117.294937,99.05 L117.294937,15.95 L95.2449367,15.95 L95.2449367,119 L168.594937,119 Z M200.094937,119 L200.094937,52.4 L249.894937,119 L271.944937,119 L271.944937,15.95 L249.894937,15.95 L249.894937,82.55 L200.094937,15.95 L178.044937,15.95 L178.044937,119 L200.094937,119 Z M321.494937,120.8 C328.194937,120.8 334.269937,119.075 339.719937,115.625 C345.169937,112.175 349.444937,107.35 352.544937,101.15 C355.644937,94.95 357.194937,87.95 357.194937,80.15 C357.194937,72.35 355.644937,65.375 352.544937,59.225 C349.444937,53.075 345.169937,48.275 339.719937,44.825 C334.269937,41.375 328.194937,39.65 321.494937,39.65 C315.394937,39.65 309.919937,41.075 305.069937,43.925 C300.219937,46.775 296.294937,50.8 293.294937,56 L293.294937,56 L293.294937,14.15 L282.044937,14.15 L282.044937,119 L293.294937,119 L293.294937,104.45 C296.294937,109.65 300.219937,113.675 305.069937,116.525 C309.919937,119.375 315.394937,120.8 321.494937,120.8 Z M319.394937,110.75 C314.394937,110.75 309.894937,109.45 305.894937,106.85 C301.894937,104.25 298.794937,100.625 296.594937,95.975 C294.394937,91.325 293.294937,86.05 293.294937,80.15 C293.294937,74.25 294.394937,69 296.594937,64.4 C298.794937,59.8 301.894937,56.2 305.894937,53.6 C309.894937,51 314.394937,49.7 319.394937,49.7 C324.394937,49.7 328.869937,51 332.819937,53.6 C336.769937,56.2 339.844937,59.8 342.044937,64.4 C344.244937,69 345.344937,74.25 345.344937,80.15 C345.344937,86.05 344.244937,91.325 342.044937,95.975 C339.844937,100.625 336.769937,104.25 332.819937,106.85 C328.869937,109.45 324.394937,110.75 319.394937,110.75 Z M368.844937,27.35 C370.844937,27.35 372.569937,26.6 374.019937,25.1 C375.469937,23.6 376.194937,21.85 376.194937,19.85 C376.194937,17.85 375.469937,16.125 374.019937,14.675 C372.569937,13.225 370.844937,12.5 368.844937,12.5 C366.744937,12.5 364.969937,13.225 363.519937,14.675 C362.069937,16.125 361.344937,17.85 361.344937,19.85 C361.344937,21.85 362.069937,23.6 363.519937,25.1 C364.969937,26.6 366.744937,27.35 368.844937,27.35 Z M374.394937,119 L374.394937,41.45 L363.144937,41.45 L363.144937,119 L374.394937,119 Z M415.494937,120.8 C420.894937,120.8 425.694937,119.15 429.894937,115.85 L429.894937,115.85 L424.344937,107.6 C423.444937,108.5 422.294937,109.25 420.894937,109.85 C419.494937,110.45 417.944937,110.75 416.244937,110.75 C413.944937,110.75 411.969937,109.825 410.319937,107.975 C408.669937,106.125 407.844937,103.8 407.844937,101 L407.844937,101 L407.844937,51.5 L426.894937,51.5 L426.894937,41.45 L407.844937,41.45 L407.844937,20.15 L396.594937,20.15 L396.594937,41.45 L384.444937,41.45 L384.444937,51.5 L396.594937,51.5 L396.594937,101 C396.594937,106.8 398.369937,111.55 401.919937,115.25 C405.469937,118.95 409.994937,120.8 415.494937,120.8 Z M466.694937,120.8 C474.894937,120.8 481.669937,118.65 487.019937,114.35 C492.369937,110.05 495.044937,104.4 495.044937,97.4 C495.044937,92.8 493.894937,89.075 491.594937,86.225 C489.294937,83.375 486.444937,81.15 483.044937,79.55 C479.644937,77.95 475.194937,76.3 469.694937,74.6 C464.094937,72.8 459.994937,71.35 457.394937,70.25 C454.794937,69.15 452.844937,67.9 451.544937,66.5 C450.244937,65.1 449.594937,63.3 449.594937,61.1 C449.594937,57.5 451.094937,54.7 454.094937,52.7 C457.094937,50.7 460.894937,49.7 465.494937,49.7 C472.694937,49.7 480.144937,52.15 487.844937,57.05 L487.844937,57.05 L493.244937,48.35 C489.044937,45.65 484.544937,43.525 479.744937,41.975 C474.944937,40.425 470.194937,39.65 465.494937,39.65 C457.594937,39.65 451.094937,41.725 445.994937,45.875 C440.894937,50.025 438.344937,55.55 438.344937,62.45 C438.344937,67.95 440.294937,72.325 444.194937,75.575 C448.094937,78.825 454.794937,81.8 464.294937,84.5 C468.794937,85.8 472.319937,86.95 474.869937,87.95 C477.419937,88.95 479.544937,90.325 481.244937,92.075 C482.944937,93.825 483.794937,96 483.794937,98.6 C483.794937,102.3 482.219937,105.25 479.069937,107.45 C475.919937,109.65 471.794937,110.75 466.694937,110.75 C458.094937,110.75 449.344937,107.5 440.444937,101 L440.444937,101 L434.594937,109.25 C439.194937,112.95 444.319937,115.8 449.969937,117.8 C455.619937,119.8 461.194937,120.8 466.694937,120.8 Z" id="LNbits" fill="currentColor"></path>
                                <polygon id="Path" fill="#FF1EE6" points="31.7629055 0 7.10760662 78.8585043 26.9789129 78.8585043 2.69673524e-13 148 74.8401889 57.3517272 43.9349963 57.3517272 84.3037975 8.34401992e-14"></polygon>
                            </g>
                        </g>
                    </g>
                </g>
            </svg>
            <span class="text-ln-muted font-mono text-xs uppercase tracking-widest">Box</span>
        </div>
        <a href="{{ url_for('logout') }}"
           class="text-ln-muted hover:text-ln-pink font-mono text-xs uppercase tracking-wider transition-colors">
            Sign Out
        </a>
    </div>

    {# ── LNbits status and link to LNbitsBox at / ── #}
    <div class="bg-ln-surface border border-ln-border rounded-xl p-4 mb-6 transition-all duration-500" id="lnbits-status-card">
        <div class="flex items-center justify-between mb-2">
            <p class="text-ln-text text-sm font-medium">LNbits Status</p>
            <span class="text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300"
                  id="lnbits-status-badge">
                --
            </span>
        </div>
        <div class="flex items-center gap-3">
            <div class="w-2.5 h-2.5 rounded-full transition-colors duration-300" id="lnbits-status-dot"></div>
            <span class="text-ln-muted text-sm transition-colors duration-300" id="lnbits-status-text">Checking...</span>
        </div>
        <a href="/" target="_blank" id="lnbits-open-link"
           class="inline-block mt-4 text-ln-pink hover:text-ln-pink-dim text-sm font-mono uppercase tracking-wider transition-colors">
            Open LNbits
        </a>
    </div>

    {# ── Tor Address ── #}
    <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5 mb-6">
        <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Tor Address</div>
        <div class="flex items-center gap-3">
            <div class="w-2.5 h-2.5 rounded-full" id="tor-dot"></div>
            <code class="text-sm sm:text-base font-mono text-ln-text truncate flex-1" id="stat-tor-address">--</code>
            <button onclick="copyOnion()" id="tor-copy-btn"
                    class="hidden text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30 shrink-0">
                Copy
            </button>
        </div>
    </div>

    {# ── LNbits Database + System Update row ── #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-6">

    {# ── LNbits Database ── #}
    <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5 transition-all duration-500" id="db-card">
        <div class="flex items-center justify-between mb-3">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider">LNbits Database</div>
            <span class="text-xs font-mono text-ln-muted" id="db-size">--</span>
        </div>

        <p class="text-ln-muted text-xs font-mono mb-4">
            LNbits will be temporarily stopped during backup and restore operations.
        </p>

        {# Status indicator (hidden by default) #}
        <div id="db-status" class="hidden mb-4">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 border-2 border-ln-pink border-t-transparent rounded-full animate-spin"></div>
                <span class="text-ln-muted text-sm font-mono" id="db-status-text">Processing...</span>
            </div>
        </div>

        <div class="flex gap-3" id="db-buttons">
            <button onclick="confirmDbBackup()" id="db-backup-btn"
                    class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1.5 border border-ln-border rounded-lg hover:border-ln-pink/30">
                Download Backup
            </button>
            <button onclick="openRestoreModal()" id="db-restore-btn"
                    class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1.5 border border-ln-border rounded-lg hover:border-ln-pink/30">
                Restore Backup
            </button>
        </div>
    </div>

    {# ── System Update ── #}
    <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5 transition-all duration-500" id="update-card">
        <div class="flex items-center justify-between mb-3">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider">System Update</div>
            <span class="text-xs font-mono text-ln-muted" id="update-current-version">--</span>
        </div>

        {# Update available #}
        <div id="update-available" class="hidden">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border text-ln-pink border-ln-pink/30 bg-ln-pink/5">
                    Update available
                </span>
                <span class="text-sm font-mono text-ln-text" id="update-latest-version"></span>
            </div>
            <div class="text-ln-muted text-xs font-mono mb-3 max-h-24 overflow-y-auto whitespace-pre-wrap border border-ln-border rounded-lg p-2" id="update-release-notes"></div>
            <button onclick="confirmUpdate()"
                    class="bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2 px-4 rounded-lg transition-colors">
                Update Now
            </button>
        </div>

        {# Update in progress #}
        <div id="update-progress" class="hidden">
            <div class="flex items-center gap-2 mb-3">
                <div class="w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse"></div>
                <span class="text-amber-400 text-sm font-mono" id="update-progress-status">Updating...</span>
            </div>
            <div class="bg-ln-surface border border-ln-border rounded-lg p-2 max-h-40 overflow-y-auto font-mono text-xs text-ln-muted" id="update-log">
            </div>
        </div>

        {# Update complete #}
        <div id="update-done" class="hidden">
            <div class="flex items-center gap-2">
                <div class="w-2.5 h-2.5 rounded-full" id="update-done-dot"></div>
                <span class="text-sm font-mono" id="update-done-text"></span>
            </div>
        </div>

        {# Idle / check state #}
        <div class="flex items-center gap-3 mt-3" id="update-check-section">
            <button onclick="checkForUpdate()"
                    class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1.5 border border-ln-border rounded-lg hover:border-ln-pink/30"
                    id="update-check-btn">
                Check for updates
            </button>
            <span class="text-ln-muted text-xs font-mono" id="update-check-status"></span>
        </div>
    </div>

    </div> {# close Database + Update grid #}

    {# ── Metric Cards ── #}
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 sm:gap-4 mb-6">

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Spark Balance</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-balance">--</div>
            <div class="text-ln-muted text-xs font-mono mt-1">sats</div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">System Uptime</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-uptime">--</div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">CPU Temperature</div>
            <div class="text-2xl sm:text-3xl font-display font-bold" id="stat-temp">--</div>
            <div class="text-ln-muted text-xs font-mono mt-1" id="stat-temp-unit">&deg;C</div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Disk Usage</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-disk">--</div>
            <div class="w-full bg-ln-surface rounded-full h-1.5 mt-2">
                <div class="bg-ln-pink rounded-full h-1.5 transition-all duration-500" id="stat-disk-bar" style="width: 0%"></div>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <span class="text-ln-muted text-xs font-mono"><span id="stat-disk-detail">--</span></span>
            </div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Memory Usage</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-ram">--</div>
            <div class="w-full bg-ln-surface rounded-full h-1.5 mt-2">
                <div class="bg-ln-pink rounded-full h-1.5 transition-all duration-500" id="stat-ram-bar" style="width: 0%"></div>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <span class="text-ln-muted text-xs font-mono"><span id="stat-ram-detail">--</span></span>
            </div>
        </div>
    </div>

    {# ── Charts ── #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4 mb-6">

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-3">Temperature</div>
            <div class="h-48">
                <canvas id="chart-temp"></canvas>
            </div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-3">CPU Usage</div>
            <div class="h-48">
                <canvas id="chart-cpu"></canvas>
            </div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-3">Memory Usage</div>
            <div class="h-48">
                <canvas id="chart-ram"></canvas>
            </div>
        </div>
    </div>

    {# ── Services + Network + System ── #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4">

        {# Services #}
        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-4">Services</div>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full" id="svc-lnbits-dot"></div>
                        <span class="font-mono text-sm">LNbits</span>
                        <span class="text-ln-muted font-mono text-xs" id="svc-lnbits-status">--</span>
                    </div>
                    <button onclick="restartService('lnbits')"
                            class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30">
                        Restart
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full" id="svc-spark-sidecar-dot"></div>
                        <span class="font-mono text-sm">Spark</span>
                        <span class="text-ln-muted font-mono text-xs" id="svc-spark-sidecar-status">--</span>
                    </div>
                    <button onclick="restartService('spark-sidecar')"
                            class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30">
                        Restart
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full" id="svc-tor-dot"></div>
                        <span class="font-mono text-sm">Tor</span>
                        <span class="text-ln-muted font-mono text-xs" id="svc-tor-status">--</span>
                    </div>
                    <button onclick="restartService('tor')"
                            class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30">
                        Restart
                    </button>
                </div>
            </div>
        </div>

        {# Network #}
        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-4">Network</div>
            <div class="space-y-3">
                <div class="flex items-center gap-3">
                    <div class="w-2.5 h-2.5 rounded-full bg-gray-600" id="net-internet-dot"></div>
                    <span class="font-mono text-sm">Internet</span>
                    <span class="text-ln-muted font-mono text-xs" id="net-internet-status">--</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-2.5 h-2.5 rounded-full bg-gray-600 shrink-0" id="net-wifi-dot"></div>
                        <span class="font-mono text-sm shrink-0">WiFi</span>
                        <span class="text-ln-muted font-mono text-xs truncate" id="net-wifi-status">--</span>
                    </div>
                    <button onclick="openWifiScan()"
                            class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30 shrink-0 ml-2">
                        Scan
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-2.5 h-2.5 rounded-full bg-gray-600" id="net-eth-dot"></div>
                    <span class="font-mono text-sm">Ethernet</span>
                    <span class="text-ln-muted font-mono text-xs" id="net-eth-status">--</span>
                </div>
            </div>
        </div>

        {# System Actions #}
        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-4">System</div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmAction('reboot', 'Reboot LNbitsBox?')"
                        class="bg-ln-surface hover:bg-ln-card-hover border border-ln-border hover:border-amber-500/30 text-ln-text font-mono text-sm py-3 px-4 rounded-lg transition-all duration-200">
                    Restart
                </button>
                <button onclick="confirmAction('shutdown', 'Shut down LNbitsBox?')"
                        class="bg-ln-surface hover:bg-ln-card-hover border border-ln-border hover:border-red-500/30 text-ln-text font-mono text-sm py-3 px-4 rounded-lg transition-all duration-200">
                    Shutdown
                </button>
            </div>
        </div>
    </div>

    {# ── Footer ── #}
    <div class="mt-8 text-center">
        <p class="text-ln-muted text-xs font-mono tracking-wider uppercase">
            LNbitsBox &middot; Powered by LNbits
        </p>
    </div>
</div>

{# ── Confirm Modal ── #}
<div id="confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-ln-card border border-ln-border rounded-2xl p-6 max-w-sm w-full glow-pink">
        <p class="text-lg font-display font-semibold mb-2" id="confirm-title">Are you sure?</p>
        <p class="text-ln-muted text-sm font-mono mb-6" id="confirm-message"></p>
        <div class="flex gap-3">
            <button onclick="closeModal()"
                    class="flex-1 bg-ln-surface border border-ln-border text-ln-text font-mono text-sm py-2.5 rounded-lg hover:bg-ln-card-hover transition-colors">
                Cancel
            </button>
            <button id="confirm-btn"
                    class="flex-1 bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2.5 rounded-lg transition-colors">
                Confirm
            </button>
        </div>
    </div>
</div>

{# ── WiFi Scan Modal ── #}
<div id="wifi-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-ln-card border border-ln-border rounded-2xl p-6 max-w-md w-full">
        <div class="flex items-center justify-between mb-4">
            <p class="text-lg font-display font-semibold">WiFi Networks</p>
            <button onclick="closeWifiModal()" class="text-ln-muted hover:text-ln-text transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>

        {# Scan results list #}
        <div id="wifi-scan-list">
            <div class="flex items-center justify-center py-8">
                <div class="w-5 h-5 border-2 border-ln-pink border-t-transparent rounded-full animate-spin mr-3"></div>
                <span class="text-ln-muted font-mono text-sm">Scanning...</span>
            </div>
        </div>

        {# Connect form (hidden initially) #}
        <div id="wifi-connect-form" class="hidden">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="showScanList()" class="text-ln-muted hover:text-ln-text transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <span class="font-mono text-sm font-semibold" id="wifi-connect-ssid"></span>
            </div>
            <div id="wifi-password-group" class="mb-4">
                <label class="text-ln-muted text-xs font-mono uppercase tracking-wider block mb-1.5">Password</label>
                <input type="password" id="wifi-password"
                       class="w-full bg-ln-surface border border-ln-border rounded-lg px-3 py-2 text-sm font-mono text-ln-text focus:border-ln-pink/50 focus:outline-none transition-colors"
                       placeholder="Enter password">
            </div>
            <div class="flex gap-3">
                <button onclick="showScanList()"
                        class="flex-1 bg-ln-surface border border-ln-border text-ln-text font-mono text-sm py-2.5 rounded-lg hover:bg-ln-card-hover transition-colors">
                    Cancel
                </button>
                <button onclick="connectToWifi()"
                        class="flex-1 bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2.5 rounded-lg transition-colors">
                    Connect
                </button>
            </div>
        </div>

        {# Connecting status #}
        <div id="wifi-connecting" class="hidden">
            <div class="flex flex-col items-center py-6">
                <div class="w-6 h-6 border-2 border-ln-pink border-t-transparent rounded-full animate-spin mb-3"></div>
                <span class="text-ln-muted font-mono text-sm" id="wifi-connecting-text">Connecting...</span>
            </div>
        </div>

        {# Result #}
        <div id="wifi-result" class="hidden">
            <div class="flex flex-col items-center py-6">
                <div class="w-8 h-8 rounded-full mb-3" id="wifi-result-icon"></div>
                <span class="font-mono text-sm mb-1" id="wifi-result-text"></span>
                <span class="text-ln-muted font-mono text-xs" id="wifi-result-ip"></span>
            </div>
            <div class="flex gap-3" id="wifi-result-actions">
                <button onclick="showScanList()"
                        class="flex-1 bg-ln-surface border border-ln-border text-ln-text font-mono text-sm py-2.5 rounded-lg hover:bg-ln-card-hover transition-colors">
                    Try Another
                </button>
                <button onclick="closeWifiModal()"
                        class="flex-1 bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2.5 rounded-lg transition-colors">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

{# ── Database Restore Modal ── #}
<div id="restore-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-ln-card border border-ln-border rounded-2xl p-6 max-w-md w-full">
        <div class="flex items-center justify-between mb-4">
            <p class="text-lg font-display font-semibold">Restore Database</p>
            <button onclick="closeRestoreModal()" class="text-ln-muted hover:text-ln-text transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>

        {# Upload form #}
        <div id="restore-form">
            <div class="bg-red-400/5 border border-red-400/20 rounded-lg p-3 mb-4">
                <p class="text-red-400 text-xs font-mono leading-relaxed">
                    This will overwrite your current LNbits database. All existing data (wallets, extensions, settings) will be replaced. This action cannot be undone.
                </p>
            </div>

            <label class="text-ln-muted text-xs font-mono uppercase tracking-wider block mb-1.5">Backup File</label>
            <input type="file" id="restore-file" accept=".zip"
                   class="w-full bg-ln-surface border border-ln-border rounded-lg px-3 py-2 text-sm font-mono text-ln-text file:mr-3 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-mono file:bg-ln-pink/10 file:text-ln-pink hover:file:bg-ln-pink/20 focus:border-ln-pink/50 focus:outline-none transition-colors mb-4">

            <div class="flex gap-3">
                <button onclick="closeRestoreModal()"
                        class="flex-1 bg-ln-surface border border-ln-border text-ln-text font-mono text-sm py-2.5 rounded-lg hover:bg-ln-card-hover transition-colors">
                    Cancel
                </button>
                <button onclick="startRestore()" id="restore-confirm-btn"
                        class="flex-1 bg-red-500 hover:bg-red-600 text-white font-mono text-sm py-2.5 rounded-lg transition-colors">
                    Restore
                </button>
            </div>
        </div>

        {# Progress #}
        <div id="restore-progress" class="hidden">
            <div class="flex flex-col items-center py-6">
                <div class="w-6 h-6 border-2 border-ln-pink border-t-transparent rounded-full animate-spin mb-3"></div>
                <span class="text-ln-muted font-mono text-sm">Restoring database...</span>
            </div>
        </div>

        {# Result #}
        <div id="restore-result" class="hidden">
            <div class="flex flex-col items-center py-6">
                <div class="w-8 h-8 rounded-full mb-3" id="restore-result-icon"></div>
                <span class="font-mono text-sm mb-1" id="restore-result-text"></span>
            </div>
            <button onclick="closeRestoreModal()"
                    class="w-full bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2.5 rounded-lg transition-colors">
                Close
            </button>
        </div>
    </div>
</div>

<script>
// ── Theme-aware colors ─────────────────────────────────────────
const _cs = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim().split(' ').join(',');
const thBorder = _cs('--ln-border');
const thMuted  = _cs('--ln-muted');

// ── Chart Setup ────────────────────────────────────────────────
const chartOpts = {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 300 },
    plugins: {
        legend: { display: false },
        tooltip: {
            enabled: true,
            backgroundColor: 'rgb(' + _cs('--ln-card') + ')',
            titleColor: 'rgb(' + thMuted + ')',
            bodyColor: 'rgb(' + _cs('--ln-text') + ')',
            borderColor: 'rgb(' + thBorder + ')',
            borderWidth: 1,
            titleFont: { family: 'JetBrains Mono', size: 11 },
            bodyFont: { family: 'JetBrains Mono', size: 12 },
            padding: 8,
            displayColors: false,
            callbacks: {
                label: ctx => ctx.parsed.y.toFixed(1) + '%',
            },
        },
    },
    interaction: {
        mode: 'index',
        intersect: false,
    },
    scales: {
        x: {
            display: true,
            grid: { display: false },
            ticks: {
                color: 'rgb(' + thMuted + ')',
                font: { family: 'JetBrains Mono', size: 9 },
                maxTicksLimit: 6,
            },
        },
        y: {
            min: 0, max: 100,
            grid: { color: 'rgba(' + thBorder + ',0.5)' },
            ticks: {
                color: 'rgb(' + thMuted + ')',
                font: { family: 'JetBrains Mono', size: 10 },
                callback: v => v + '%',
            },
        },
    },
    elements: {
        point: { radius: 0, hoverRadius: 5, hitRadius: 20, hoverBorderWidth: 2 },
        line: { tension: 0.3, borderWidth: 2 },
    },
};

const cpuChart = new Chart(document.getElementById('chart-cpu'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            data: [],
            borderColor: '#FF1EE6',
            backgroundColor: 'rgba(255,30,230,0.08)',
            fill: true,
        }],
    },
    options: { ...chartOpts },
});

const ramChart = new Chart(document.getElementById('chart-ram'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            data: [],
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34,211,238,0.08)',
            fill: true,
        }],
    },
    options: { ...chartOpts },
});

const tempChartOpts = JSON.parse(JSON.stringify(chartOpts));
tempChartOpts.scales.y = {
    min: 20, max: 90,
    grid: { color: 'rgba(' + thBorder + ',0.5)' },
    ticks: {
        color: 'rgb(' + thMuted + ')',
        font: { family: 'JetBrains Mono', size: 10 },
        callback: v => v + '°',
    },
};
tempChartOpts.plugins.tooltip.callbacks = { label: ctx => ctx.parsed.y.toFixed(1) + '°C' };

const tempChart = new Chart(document.getElementById('chart-temp'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            data: [],
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245,158,11,0.08)',
            fill: true,
        }],
    },
    options: tempChartOpts,
});

// ── Stats Polling ──────────────────────────────────────────────
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
}

function tempColor(temp) {
    if (temp === null) return 'text-ln-muted';
    if (temp < 55) return 'text-emerald-400';
    if (temp < 70) return 'text-amber-400';
    return 'text-red-400';
}

function svcColor(status) {
    return status === 'active' ? 'bg-emerald-400' : 'bg-red-400';
}

async function fetchStats() {
    try {
        const resp = await fetch('/box/api/stats');
        if (!resp.ok) return;
        const data = await resp.json();
        const s = data.current;

        // Balance
        const bal = s.spark_balance;
        document.getElementById('stat-balance').textContent =
            bal && bal.balance !== undefined ? Number(bal.balance).toLocaleString() : '--';

        // Uptime
        document.getElementById('stat-uptime').textContent = s.uptime.formatted;

        // Temperature
        const tempEl = document.getElementById('stat-temp');
        tempEl.textContent = s.cpu_temp !== null ? s.cpu_temp : '--';
        tempEl.className = 'text-2xl sm:text-3xl font-display font-bold ' + tempColor(s.cpu_temp);

        // Disk
        document.getElementById('stat-disk').textContent = s.disk.percent + '%';
        document.getElementById('stat-disk-bar').style.width = s.disk.percent + '%';
        document.getElementById('stat-disk-detail').textContent =
            formatBytes(s.disk.used) + ' / ' + formatBytes(s.disk.total);

        // RAM
        document.getElementById('stat-ram').textContent = s.ram.percent + '%';
        document.getElementById('stat-ram-bar').style.width = s.ram.percent + '%';
        document.getElementById('stat-ram-detail').textContent =
            formatBytes(s.ram.used) + ' / ' + formatBytes(s.ram.total);

        // Tor
        const onion = s.tor_onion;
        const torAddr = document.getElementById('stat-tor-address');
        const torDot = document.getElementById('tor-dot');
        const torCopyBtn = document.getElementById('tor-copy-btn');
        if (onion) {
            torAddr.textContent = onion;
            torDot.className = 'w-2.5 h-2.5 rounded-full bg-purple-400';
            torCopyBtn.classList.remove('hidden');
        } else {
            torAddr.textContent = 'Waiting for Tor...';
            torDot.className = 'w-2.5 h-2.5 rounded-full bg-ln-muted animate-pulse';
            torCopyBtn.classList.add('hidden');
        }

        // Services
        for (const svc of ['lnbits', 'spark-sidecar', 'tor']) {
            const key = svc.replace('-', '-');
            const status = s.services[svc] || 'unknown';
            document.getElementById('svc-' + svc + '-dot').className =
                'w-2.5 h-2.5 rounded-full ' + svcColor(status);
            document.getElementById('svc-' + svc + '-status').textContent = status;
        }

        // Network
        if (s.network) {
            const net = s.network;
            // Internet
            document.getElementById('net-internet-dot').className =
                'w-2.5 h-2.5 rounded-full ' + (net.internet ? 'bg-emerald-400' : 'bg-red-400');
            document.getElementById('net-internet-status').textContent =
                net.internet ? 'Connected' : 'Disconnected';
            // WiFi
            if (net.wifi) {
                document.getElementById('net-wifi-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400 shrink-0';
                document.getElementById('net-wifi-status').textContent =
                    '"' + net.wifi.ssid + '" (' + net.wifi.ip + ')';
            } else {
                document.getElementById('net-wifi-dot').className = 'w-2.5 h-2.5 rounded-full bg-gray-600 shrink-0';
                document.getElementById('net-wifi-status').textContent = 'Not connected';
            }
            // Ethernet
            if (net.ethernet) {
                document.getElementById('net-eth-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
                document.getElementById('net-eth-status').textContent = net.ethernet.ip;
            } else {
                document.getElementById('net-eth-dot').className = 'w-2.5 h-2.5 rounded-full bg-gray-600';
                document.getElementById('net-eth-status').textContent = 'Not connected';
            }
        }

        // LNbits status card is updated by its own poller (updateLnbitsStatus)

        // Charts
        const labels = data.history.timestamps.map(t => {
            const d = new Date(t);
            return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        });

        cpuChart.data.labels = labels;
        cpuChart.data.datasets[0].data = data.history.cpu;
        cpuChart.update('none');

        ramChart.data.labels = labels;
        ramChart.data.datasets[0].data = data.history.ram;
        ramChart.update('none');

        tempChart.data.labels = labels;
        tempChart.data.datasets[0].data = data.history.temp;
        tempChart.update('none');

    } catch (e) {
        console.error('Stats fetch failed:', e);
    }
}

// ── DEV_MODE: seed charts with mock data ───────────────────────
{% if dev_mode %}
(function seedMockData() {
    const now = Date.now();
    const points = 60;
    const labels = [];
    const cpu = [];
    const ram = [];
    const temp = [];
    for (let i = points; i > 0; i--) {
        const t = new Date(now - i * 30000);
        labels.push(t.getHours().toString().padStart(2,'0') + ':' + t.getMinutes().toString().padStart(2,'0'));
        cpu.push(Math.round(15 + 40 * Math.sin(i / 8) ** 2 + Math.random() * 10));
        ram.push(Math.round(45 + 15 * Math.sin(i / 12) + Math.random() * 5));
        temp.push(Math.round(42 + 12 * Math.sin(i / 10) + Math.random() * 3));
    }
    cpuChart.data.labels = labels;
    cpuChart.data.datasets[0].data = cpu;
    cpuChart.update('none');
    ramChart.data.labels = labels;
    ramChart.data.datasets[0].data = ram;
    ramChart.update('none');
    tempChart.data.labels = labels;
    tempChart.data.datasets[0].data = temp;
    tempChart.update('none');
})();
{% endif %}

// Initial fetch + poll every 10s
fetchStats();
setInterval(fetchStats, 10000);

// ── LNbits HTTP Status Polling (every 2s) ─────────────────────
async function updateLnbitsStatus() {
    const statusDot = document.getElementById('lnbits-status-dot');
    const statusText = document.getElementById('lnbits-status-text');
    const statusBadge = document.getElementById('lnbits-status-badge');
    const statusCard = document.getElementById('lnbits-status-card');
    const openLink = document.getElementById('lnbits-open-link');

    try {
        const resp = await fetch('/box/api/lnbits-status');
        if (!resp.ok) return;
        const data = await resp.json();

        if (data.status === 'running') {
            statusDot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse transition-colors duration-300';
            statusText.textContent = 'LNbits is running';
            statusText.className = 'text-emerald-400/70 text-sm transition-colors duration-300';
            statusBadge.textContent = 'running';
            statusBadge.className = 'text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300 text-emerald-400 border-emerald-400/30 bg-emerald-400/5';
            statusCard.className = 'bg-ln-surface border border-emerald-400/20 rounded-xl p-4 mb-6 transition-all duration-500';
            openLink.classList.remove('opacity-50', 'pointer-events-none');
        } else if (data.status === 'starting') {
            statusDot.className = 'w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse transition-colors duration-300';
            statusText.textContent = 'LNbits is starting...';
            statusText.className = 'text-amber-400/70 text-sm transition-colors duration-300';
            statusBadge.textContent = 'starting';
            statusBadge.className = 'text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300 text-amber-400 border-amber-400/30 bg-amber-400/5';
            statusCard.className = 'bg-ln-surface border border-amber-400/20 rounded-xl p-4 mb-6 transition-all duration-500';
            openLink.classList.add('opacity-50', 'pointer-events-none');
        } else {
            statusDot.className = 'w-2.5 h-2.5 rounded-full bg-red-400 transition-colors duration-300';
            statusText.textContent = data.status === 'error' ? 'LNbits error (HTTP ' + data.code + ')' : 'LNbits is stopped';
            statusText.className = 'text-red-400/70 text-sm transition-colors duration-300';
            statusBadge.textContent = data.status;
            statusBadge.className = 'text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300 text-red-400 border-red-400/30 bg-red-400/5';
            statusCard.className = 'bg-ln-surface border border-red-400/20 rounded-xl p-4 mb-6 transition-all duration-500';
            openLink.classList.add('opacity-50', 'pointer-events-none');
        }
    } catch (e) {
        console.error('LNbits status check failed:', e);
    }
}

updateLnbitsStatus();
setInterval(updateLnbitsStatus, 2000);

// ── Actions ────────────────────────────────────────────────────
let pendingAction = null;

function confirmAction(action, message) {
    pendingAction = action;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-modal').classList.remove('hidden');
    document.getElementById('confirm-btn').onclick = () => executeAction(action);
}

function closeModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
    pendingAction = null;
}

async function executeAction(action) {
    closeModal();
    try {
        const resp = await fetch('/box/api/' + action, { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
            // Show brief feedback
            const msg = action === 'shutdown' ? 'Shutting down...' :
                        action === 'reboot' ? 'Rebooting...' : data.message;
            alert(msg);
        } else {
            alert('Error: ' + data.message);
        }
    } catch (e) {
        alert('Request failed');
    }
}

async function copyOnion() {
    const addr = document.getElementById('stat-tor-address').textContent;
    if (!addr || addr === '--' || addr.startsWith('Waiting')) return;
    try {
        await navigator.clipboard.writeText('http://' + addr);
        const btn = document.getElementById('tor-copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
    } catch (e) {
        // Fallback for non-HTTPS contexts
        const ta = document.createElement('textarea');
        ta.value = 'http://' + addr;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const btn = document.getElementById('tor-copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
    }
}

async function restartService(service) {
    if (!confirm('Restart ' + service + '?')) return;
    try {
        const resp = await fetch('/box/api/restart/' + service, { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
            // Refresh stats after restart
            setTimeout(fetchStats, 2000);
        } else {
            alert('Error: ' + data.message);
        }
    } catch (e) {
        alert('Request failed');
    }
}

// ── WiFi Scan & Connect ────────────────────────────────────────
let wifiSelectedSsid = '';
let wifiSelectedFlags = '';
let wifiConnectPoll = null;

function signalBars(dbm) {
    if (dbm >= -50) return '\u2582\u2584\u2586\u2588';
    if (dbm >= -60) return '\u2582\u2584\u2586\u2007';
    if (dbm >= -70) return '\u2582\u2584\u2007\u2007';
    return '\u2582\u2007\u2007\u2007';
}

function isEncrypted(flags) {
    return flags && (flags.includes('WPA') || flags.includes('WEP'));
}

function showWifiView(id) {
    for (const v of ['wifi-scan-list', 'wifi-connect-form', 'wifi-connecting', 'wifi-result']) {
        document.getElementById(v).classList.toggle('hidden', v !== id);
    }
}

async function openWifiScan() {
    document.getElementById('wifi-modal').classList.remove('hidden');
    showWifiView('wifi-scan-list');
    document.getElementById('wifi-scan-list').innerHTML =
        '<div class="flex items-center justify-center py-8">' +
        '<div class="w-5 h-5 border-2 border-ln-pink border-t-transparent rounded-full animate-spin mr-3"></div>' +
        '<span class="text-ln-muted font-mono text-sm">Scanning...</span></div>';

    try {
        const resp = await fetch('/box/api/wifi/scan', { method: 'POST' });
        if (!resp.ok) throw new Error('Scan failed');
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        if (!data.networks || data.networks.length === 0) {
            document.getElementById('wifi-scan-list').innerHTML =
                '<p class="text-ln-muted font-mono text-sm text-center py-8">No networks found</p>';
            return;
        }

        let html = '<div class="space-y-1 max-h-72 overflow-y-auto">';
        for (const net of data.networks) {
            const encrypted = isEncrypted(net.flags);
            const lock = encrypted ? '<svg class="w-3.5 h-3.5 text-ln-muted shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>' : '';
            html += '<button onclick="selectWifiNetwork(\'' + net.ssid.replace(/'/g, "\\'") + '\', \'' + net.flags.replace(/'/g, "\\'") + '\')" ' +
                'class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg hover:bg-ln-surface transition-colors group">' +
                '<div class="flex items-center gap-2 min-w-0">' + lock +
                '<span class="font-mono text-sm truncate">' + net.ssid + '</span></div>' +
                '<span class="font-mono text-sm text-ln-muted shrink-0 ml-2">' + signalBars(net.signal) + '</span></button>';
        }
        html += '</div>';
        document.getElementById('wifi-scan-list').innerHTML = html;
    } catch (e) {
        document.getElementById('wifi-scan-list').innerHTML =
            '<p class="text-red-400 font-mono text-sm text-center py-8">Scan failed: ' + e.message + '</p>';
    }
}

function selectWifiNetwork(ssid, flags) {
    wifiSelectedSsid = ssid;
    wifiSelectedFlags = flags;
    document.getElementById('wifi-connect-ssid').textContent = ssid;
    document.getElementById('wifi-password').value = '';

    if (isEncrypted(flags)) {
        document.getElementById('wifi-password-group').classList.remove('hidden');
    } else {
        document.getElementById('wifi-password-group').classList.add('hidden');
    }
    showWifiView('wifi-connect-form');
}

function showScanList() {
    showWifiView('wifi-scan-list');
}

async function connectToWifi() {
    const password = document.getElementById('wifi-password').value;
    showWifiView('wifi-connecting');
    document.getElementById('wifi-connecting-text').textContent = 'Connecting to ' + wifiSelectedSsid + '...';

    try {
        const resp = await fetch('/box/api/wifi/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ssid: wifiSelectedSsid, password: password }),
        });
        const data = await resp.json();
        if (data.status === 'error') {
            showWifiResult(false, data.message, '');
            return;
        }
    } catch (e) {
        showWifiResult(false, 'Failed to start connection', '');
        return;
    }

    // Poll for status
    wifiConnectPoll = setInterval(async () => {
        try {
            const resp = await fetch('/box/api/wifi/connect/status');
            const data = await resp.json();
            if (data.status === 'success') {
                clearInterval(wifiConnectPoll);
                wifiConnectPoll = null;
                showWifiResult(true, data.message, data.ip);
                // Refresh stats to show new connection
                setTimeout(fetchStats, 2000);
            } else if (data.status === 'failed') {
                clearInterval(wifiConnectPoll);
                wifiConnectPoll = null;
                showWifiResult(false, data.message, '');
            }
        } catch (e) {
            // keep polling
        }
    }, 2000);
}

function showWifiResult(success, message, ip) {
    showWifiView('wifi-result');
    const icon = document.getElementById('wifi-result-icon');
    const text = document.getElementById('wifi-result-text');
    const ipEl = document.getElementById('wifi-result-ip');

    if (success) {
        icon.className = 'w-8 h-8 rounded-full mb-3 bg-emerald-400';
        text.textContent = message;
        text.className = 'font-mono text-sm mb-1 text-emerald-400';
        ipEl.textContent = ip ? 'IP: ' + ip : '';
        // Auto-close after 3s
        setTimeout(() => {
            if (!document.getElementById('wifi-modal').classList.contains('hidden')) {
                closeWifiModal();
            }
        }, 3000);
    } else {
        icon.className = 'w-8 h-8 rounded-full mb-3 bg-red-400';
        text.textContent = message;
        text.className = 'font-mono text-sm mb-1 text-red-400';
        ipEl.textContent = '';
    }
}

function closeWifiModal() {
    document.getElementById('wifi-modal').classList.add('hidden');
    if (wifiConnectPoll) {
        clearInterval(wifiConnectPoll);
        wifiConnectPoll = null;
    }
}

// ── Database Backup & Restore ──────────────────────────────────

async function fetchDbInfo() {
    try {
        const resp = await fetch('/box/api/db/info');
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.size !== undefined) {
            document.getElementById('db-size').textContent = formatBytes(data.size);
        }
    } catch (e) {
        console.error('DB info fetch failed:', e);
    }
}

fetchDbInfo();

function setDbBusy(busy, text) {
    const status = document.getElementById('db-status');
    const buttons = document.getElementById('db-buttons');
    if (busy) {
        status.classList.remove('hidden');
        document.getElementById('db-status-text').textContent = text || 'Processing...';
        buttons.querySelectorAll('button').forEach(b => { b.disabled = true; b.classList.add('opacity-50'); });
    } else {
        status.classList.add('hidden');
        buttons.querySelectorAll('button').forEach(b => { b.disabled = false; b.classList.remove('opacity-50'); });
    }
}

function confirmDbBackup() {
    document.getElementById('confirm-title').textContent = 'Download Backup?';
    document.getElementById('confirm-message').textContent =
        'LNbits will be stopped while creating the backup. It will be restarted automatically.';
    document.getElementById('confirm-modal').classList.remove('hidden');
    document.getElementById('confirm-btn').onclick = () => { closeModal(); startDbBackup(); };
}

function startDbBackup() {
    setDbBusy(true, 'Creating backup... LNbits is stopping.');

    // Use a hidden iframe to trigger the file download
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    // We need to POST, so create a form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/box/api/db/backup';
    form.target = iframe.name = 'db-backup-frame-' + Date.now();
    iframe.name = form.target;
    document.body.appendChild(form);
    form.submit();

    // Poll to detect when download completes (check if LNbits is back)
    setTimeout(() => {
        setDbBusy(false);
        document.body.removeChild(form);
        setTimeout(() => document.body.removeChild(iframe), 5000);
        fetchDbInfo();
    }, 5000);
}

function openRestoreModal() {
    document.getElementById('restore-modal').classList.remove('hidden');
    document.getElementById('restore-file').value = '';
    showRestoreView('restore-form');
}

function closeRestoreModal() {
    document.getElementById('restore-modal').classList.add('hidden');
}

function showRestoreView(id) {
    for (const v of ['restore-form', 'restore-progress', 'restore-result']) {
        document.getElementById(v).classList.toggle('hidden', v !== id);
    }
}

async function startRestore() {
    const fileInput = document.getElementById('restore-file');
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select a backup file.');
        return;
    }

    const file = fileInput.files[0];
    if (!file.name.endsWith('.zip')) {
        alert('Please select a .zip file.');
        return;
    }

    showRestoreView('restore-progress');

    const formData = new FormData();
    formData.append('file', file);

    try {
        const resp = await fetch('/box/api/db/restore', {
            method: 'POST',
            body: formData,
        });
        const data = await resp.json();

        showRestoreView('restore-result');
        const icon = document.getElementById('restore-result-icon');
        const text = document.getElementById('restore-result-text');

        if (resp.ok && data.status === 'ok') {
            icon.className = 'w-8 h-8 rounded-full mb-3 bg-emerald-400';
            text.textContent = data.message;
            text.className = 'font-mono text-sm mb-1 text-emerald-400';
            fetchDbInfo();
        } else {
            icon.className = 'w-8 h-8 rounded-full mb-3 bg-red-400';
            text.textContent = data.error || 'Restore failed';
            text.className = 'font-mono text-sm mb-1 text-red-400';
        }
    } catch (e) {
        showRestoreView('restore-result');
        document.getElementById('restore-result-icon').className = 'w-8 h-8 rounded-full mb-3 bg-red-400';
        const text = document.getElementById('restore-result-text');
        text.textContent = 'Request failed: ' + e.message;
        text.className = 'font-mono text-sm mb-1 text-red-400';
    }
}

// ── System Update ──────────────────────────────────────────────
let updateReleaseTag = '';
let updatePollInterval = null;
let updateReconnectInterval = null;

function showUpdateSection(id) {
    for (const s of ['update-available', 'update-progress', 'update-done']) {
        document.getElementById(s).classList.toggle('hidden', s !== id);
    }
}

async function checkForUpdate() {
    const btn = document.getElementById('update-check-btn');
    const status = document.getElementById('update-check-status');
    btn.disabled = true;
    status.textContent = 'Checking...';

    try {
        const resp = await fetch('/box/api/update/check');
        if (!resp.ok) { status.textContent = 'Check failed'; btn.disabled = false; return; }
        const data = await resp.json();

        document.getElementById('update-current-version').textContent = 'v' + data.current_version;

        if (data.update_available) {
            updateReleaseTag = data.release_tag;
            document.getElementById('update-latest-version').textContent = 'v' + data.latest_version;
            document.getElementById('update-release-notes').textContent = data.release_notes || 'No release notes.';
            showUpdateSection('update-available');
            // hide update-check-section while update is available
            document.getElementById('update-check-section').classList.add('hidden');
        } else {
            status.textContent = 'Up to date';
            setTimeout(() => { status.textContent = ''; }, 3000);
        }
    } catch (e) {
        status.textContent = 'Check failed';
    }
    btn.disabled = false;
}

function confirmUpdate() {
    document.getElementById('confirm-message').textContent =
        'This will download and activate a new system version. Services will briefly restart.';
    document.getElementById('confirm-title').textContent = 'Start System Update?';
    document.getElementById('confirm-modal').classList.remove('hidden');
    document.getElementById('confirm-btn').onclick = () => { closeModal(); startUpdate(); };
}

async function startUpdate() {
    showUpdateSection('update-progress');
    document.getElementById('update-log').textContent = '';
    document.getElementById('update-progress-status').textContent = 'Starting update...';

    try {
        const resp = await fetch('/box/api/update/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ release_tag: updateReleaseTag }),
        });
        const data = await resp.json();
        if (data.status !== 'started') {
            document.getElementById('update-progress-status').textContent = 'Error: ' + (data.message || 'Unknown');
            return;
        }
    } catch (e) {
        document.getElementById('update-progress-status').textContent = 'Failed to start update';
        return;
    }

    // Start polling for status
    pollUpdateStatus();
    updatePollInterval = setInterval(pollUpdateStatus, 2000);
}

async function pollUpdateStatus() {
    try {
        const resp = await fetch('/box/api/update/status');
        if (!resp.ok) throw new Error('status fetch failed');
        const data = await resp.json();

        const logEl = document.getElementById('update-log');
        if (data.log_lines && data.log_lines.length > 0) {
            logEl.textContent = data.log_lines.join('\n');
            logEl.scrollTop = logEl.scrollHeight;
        }

        const statusLabels = {
            idle: 'Waiting for system to start update. This may take a moment...',
            downloading: 'Downloading updates. Please wait...',
            activating: 'Activating new system. Services will restart shortly...',
        };

        if (data.status === 'success') {
            clearInterval(updatePollInterval);
            updatePollInterval = null;
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
            document.getElementById('update-done-text').textContent = 'Update complete! Services have been restarted.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-emerald-400';
            showUpdateSection('update-done');
            // Reload the page so all stats/version info refreshes
            setTimeout(() => location.reload(), 3000);
        } else if (data.status === 'failed') {
            clearInterval(updatePollInterval);
            updatePollInterval = null;
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
            document.getElementById('update-done-text').textContent = 'Update failed. Check logs above for details.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-red-400';
            showUpdateSection('update-done');
        } else {
            document.getElementById('update-progress-status').textContent =
                statusLabels[data.status] || data.status;
        }
    } catch (e) {
        // Connection lost — admin app may be restarting during switch-to-configuration
        document.getElementById('update-progress-status').textContent =
            'Reconnecting... (services restarting)';
        startReconnect();
    }
}

function startReconnect() {
    if (updateReconnectInterval) return;
    clearInterval(updatePollInterval);
    updatePollInterval = null;

    updateReconnectInterval = setInterval(async () => {
        try {
            const resp = await fetch('/box/api/update/status');
            if (resp.ok) {
                clearInterval(updateReconnectInterval);
                updateReconnectInterval = null;
                // Resuming — poll once immediately then start regular interval
                pollUpdateStatus();
                updatePollInterval = setInterval(pollUpdateStatus, 2000);
            }
        } catch (e) {
            // Still disconnected, keep trying
        }
    }, 3000);
}

// On page load, check update status in case an update was already in progress
(async function initUpdateCard() {
    try {
        const resp = await fetch('/box/api/update/status');
        if (!resp.ok) return;
        const data = await resp.json();

        if (data.status === 'downloading' || data.status === 'activating') {
            showUpdateSection('update-progress');
            pollUpdateStatus();
            updatePollInterval = setInterval(pollUpdateStatus, 2000);
        } else if (data.status === 'success') {
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
            document.getElementById('update-done-text').textContent = 'The last update completed successfully.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-emerald-400';
            showUpdateSection('update-done');
        } else if (data.status === 'failed') {
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
            document.getElementById('update-done-text').textContent = 'Last update failed. Check logs for details.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-red-400';
            showUpdateSection('update-done');
        }
    } catch (e) {
        // Ignore — card stays in idle state
    }

    // Load current version
    try {
        const resp = await fetch('/box/api/update/check');
        if (resp.ok) {
            const data = await resp.json();
            document.getElementById('update-current-version').textContent = 'v' + data.current_version;
        }
    } catch (e) {}
})();
</script>
{% endblock %}
