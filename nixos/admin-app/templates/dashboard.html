{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 py-6">

    {# ── Header ── #}
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <img src="{{ url_for('static', filename='lnbits-logo.svg') }}" alt="LNbits" class="h-6 opacity-90">
            <span class="text-ln-muted font-mono text-xs uppercase tracking-widest">Box</span>
        </div>
        <a href="{{ url_for('logout') }}"
           class="text-ln-muted hover:text-ln-pink font-mono text-xs uppercase tracking-wider transition-colors">
            Sign Out
        </a>
    </div>

    {# ── LNbits status and link to LNbitsBox at / ── #}
    <div class="bg-ln-surface border border-ln-border rounded-xl p-4 mb-6 transition-all duration-500" id="lnbits-status-card">
        <div class="flex items-center justify-between mb-2">
            <p class="text-ln-text text-sm font-medium">LNbits Status</p>
            <span class="text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300"
                  id="lnbits-status-badge">
                --
            </span>
        </div>
        <div class="flex items-center gap-3">
            <div class="w-2.5 h-2.5 rounded-full transition-colors duration-300" id="lnbits-status-dot"></div>
            <span class="text-ln-muted text-sm transition-colors duration-300" id="lnbits-status-text">Checking...</span>
        </div>
        <a href="/" target="_blank" id="lnbits-open-link"
           class="inline-block mt-4 text-ln-pink hover:text-ln-pink-dim text-sm font-mono uppercase tracking-wider transition-colors">
            Open LNbits
        </a>
    </div>

    {# ── Tor Address ── #}
    <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5 mb-6">
        <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Tor Address</div>
        <div class="flex items-center gap-3">
            <div class="w-2.5 h-2.5 rounded-full" id="tor-dot"></div>
            <code class="text-sm sm:text-base font-mono text-ln-text truncate flex-1" id="stat-tor-address">--</code>
            <button onclick="copyOnion()" id="tor-copy-btn"
                    class="hidden text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30 shrink-0">
                Copy
            </button>
        </div>
    </div>

    {# ── System Update ── #}
    <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5 mb-6 transition-all duration-500" id="update-card">
        <div class="flex items-center justify-between mb-3">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider">System Update</div>
            <span class="text-xs font-mono text-ln-muted" id="update-current-version">--</span>
        </div>

        {# Idle / check state #}
        <div id="update-idle">
            <div class="flex items-center gap-3">
                <button onclick="checkForUpdate()"
                        class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1.5 border border-ln-border rounded-lg hover:border-ln-pink/30"
                        id="update-check-btn">
                    Check for updates
                </button>
                <span class="text-ln-muted text-xs font-mono" id="update-check-status"></span>
            </div>
        </div>

        {# Update available #}
        <div id="update-available" class="hidden">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border text-ln-pink border-ln-pink/30 bg-ln-pink/5">
                    Update available
                </span>
                <span class="text-sm font-mono text-ln-text" id="update-latest-version"></span>
            </div>
            <div class="text-ln-muted text-xs font-mono mb-3 max-h-24 overflow-y-auto whitespace-pre-wrap border border-ln-border rounded-lg p-2" id="update-release-notes"></div>
            <button onclick="confirmUpdate()"
                    class="bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2 px-4 rounded-lg transition-colors">
                Update Now
            </button>
        </div>

        {# Update in progress #}
        <div id="update-progress" class="hidden">
            <div class="flex items-center gap-2 mb-3">
                <div class="w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse"></div>
                <span class="text-amber-400 text-sm font-mono" id="update-progress-status">Updating...</span>
            </div>
            <div class="bg-ln-surface border border-ln-border rounded-lg p-2 max-h-40 overflow-y-auto font-mono text-xs text-ln-muted" id="update-log">
            </div>
        </div>

        {# Update complete #}
        <div id="update-done" class="hidden">
            <div class="flex items-center gap-2">
                <div class="w-2.5 h-2.5 rounded-full" id="update-done-dot"></div>
                <span class="text-sm font-mono" id="update-done-text"></span>
            </div>
        </div>
    </div>

    {# ── Metric Cards ── #}
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Balance</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-balance">--</div>
            <div class="text-ln-muted text-xs font-mono mt-1">sats</div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Uptime</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-uptime">--</div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">CPU Temp</div>
            <div class="text-2xl sm:text-3xl font-display font-bold" id="stat-temp">--</div>
            <div class="text-ln-muted text-xs font-mono mt-1" id="stat-temp-unit">&deg;C</div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-2">Disk</div>
            <div class="text-2xl sm:text-3xl font-display font-bold text-ln-text" id="stat-disk">--</div>
            <div class="w-full bg-ln-surface rounded-full h-1.5 mt-2">
                <div class="bg-ln-pink rounded-full h-1.5 transition-all duration-500" id="stat-disk-bar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    {# ── Charts ── #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-6">

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-3">CPU Usage</div>
            <div class="h-48">
                <canvas id="chart-cpu"></canvas>
            </div>
        </div>

        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-3">Memory Usage</div>
            <div class="h-48">
                <canvas id="chart-ram"></canvas>
            </div>
        </div>
    </div>

    {# ── Services + Actions ── #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">

        {# Services #}
        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-4">Services</div>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full" id="svc-lnbits-dot"></div>
                        <span class="font-mono text-sm">lnbits</span>
                        <span class="text-ln-muted font-mono text-xs" id="svc-lnbits-status">--</span>
                    </div>
                    <button onclick="restartService('lnbits')"
                            class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30">
                        Restart
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full" id="svc-spark-sidecar-dot"></div>
                        <span class="font-mono text-sm">spark-sidecar</span>
                        <span class="text-ln-muted font-mono text-xs" id="svc-spark-sidecar-status">--</span>
                    </div>
                    <button onclick="restartService('spark-sidecar')"
                            class="text-ln-muted hover:text-ln-pink text-xs font-mono uppercase tracking-wider transition-colors px-3 py-1 border border-ln-border rounded-lg hover:border-ln-pink/30">
                        Restart
                    </button>
                </div>
            </div>
        </div>

        {# System Actions #}
        <div class="bg-ln-card border border-ln-border rounded-xl p-4 sm:p-5">
            <div class="text-ln-muted text-xs font-mono uppercase tracking-wider mb-4">System</div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmAction('reboot', 'Reboot LNbitsBox?')"
                        class="bg-ln-surface hover:bg-ln-card-hover border border-ln-border hover:border-amber-500/30 text-ln-text font-mono text-sm py-3 px-4 rounded-lg transition-all duration-200">
                    Reboot
                </button>
                <button onclick="confirmAction('shutdown', 'Shut down LNbitsBox?')"
                        class="bg-ln-surface hover:bg-ln-card-hover border border-ln-border hover:border-red-500/30 text-ln-text font-mono text-sm py-3 px-4 rounded-lg transition-all duration-200">
                    Shutdown
                </button>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                <span class="text-ln-muted text-xs font-mono">RAM: <span id="stat-ram-detail">--</span></span>
            </div>
        </div>
    </div>

    {# ── Footer ── #}
    <div class="mt-8 text-center">
        <p class="text-ln-muted text-xs font-mono tracking-wider uppercase">
            LNbitsBox &middot; Powered by LNbits
        </p>
    </div>
</div>

{# ── Confirm Modal ── #}
<div id="confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-ln-card border border-ln-border rounded-2xl p-6 max-w-sm w-full glow-pink">
        <p class="text-lg font-display font-semibold mb-2" id="confirm-title">Are you sure?</p>
        <p class="text-ln-muted text-sm font-mono mb-6" id="confirm-message"></p>
        <div class="flex gap-3">
            <button onclick="closeModal()"
                    class="flex-1 bg-ln-surface border border-ln-border text-ln-text font-mono text-sm py-2.5 rounded-lg hover:bg-ln-card-hover transition-colors">
                Cancel
            </button>
            <button id="confirm-btn"
                    class="flex-1 bg-ln-pink hover:bg-ln-pink-dim text-white font-mono text-sm py-2.5 rounded-lg transition-colors">
                Confirm
            </button>
        </div>
    </div>
</div>

<script>
// ── Chart Setup ────────────────────────────────────────────────
const chartOpts = {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 300 },
    plugins: { legend: { display: false } },
    scales: {
        x: {
            display: false,
        },
        y: {
            min: 0, max: 100,
            grid: { color: 'rgba(42,42,58,0.5)' },
            ticks: {
                color: '#7a7a8e',
                font: { family: 'JetBrains Mono', size: 10 },
                callback: v => v + '%',
            },
        },
    },
    elements: {
        point: { radius: 0 },
        line: { tension: 0.3, borderWidth: 2 },
    },
};

const cpuChart = new Chart(document.getElementById('chart-cpu'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            data: [],
            borderColor: '#FF1EE6',
            backgroundColor: 'rgba(255,30,230,0.08)',
            fill: true,
        }],
    },
    options: { ...chartOpts },
});

const ramChart = new Chart(document.getElementById('chart-ram'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            data: [],
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34,211,238,0.08)',
            fill: true,
        }],
    },
    options: { ...chartOpts },
});

// ── Stats Polling ──────────────────────────────────────────────
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
}

function tempColor(temp) {
    if (temp === null) return 'text-ln-muted';
    if (temp < 55) return 'text-emerald-400';
    if (temp < 70) return 'text-amber-400';
    return 'text-red-400';
}

function svcColor(status) {
    return status === 'active' ? 'bg-emerald-400' : 'bg-red-400';
}

async function fetchStats() {
    try {
        const resp = await fetch('/box/api/stats');
        if (!resp.ok) return;
        const data = await resp.json();
        const s = data.current;

        // Balance
        const bal = s.spark_balance;
        document.getElementById('stat-balance').textContent =
            bal && bal.balance !== undefined ? Number(bal.balance).toLocaleString() : '--';

        // Uptime
        document.getElementById('stat-uptime').textContent = s.uptime.formatted;

        // Temperature
        const tempEl = document.getElementById('stat-temp');
        tempEl.textContent = s.cpu_temp !== null ? s.cpu_temp : '--';
        tempEl.className = 'text-2xl sm:text-3xl font-display font-bold ' + tempColor(s.cpu_temp);

        // Disk
        document.getElementById('stat-disk').textContent = s.disk.percent + '%';
        document.getElementById('stat-disk-bar').style.width = s.disk.percent + '%';

        // RAM detail
        document.getElementById('stat-ram-detail').textContent =
            formatBytes(s.ram.used) + ' / ' + formatBytes(s.ram.total) + ' (' + s.ram.percent + '%)';

        // Tor
        const onion = s.tor_onion;
        const torAddr = document.getElementById('stat-tor-address');
        const torDot = document.getElementById('tor-dot');
        const torCopyBtn = document.getElementById('tor-copy-btn');
        if (onion) {
            torAddr.textContent = onion;
            torDot.className = 'w-2.5 h-2.5 rounded-full bg-purple-400';
            torCopyBtn.classList.remove('hidden');
        } else {
            torAddr.textContent = 'Waiting for Tor...';
            torDot.className = 'w-2.5 h-2.5 rounded-full bg-ln-muted animate-pulse';
            torCopyBtn.classList.add('hidden');
        }

        // Services
        for (const svc of ['lnbits', 'spark-sidecar']) {
            const key = svc.replace('-', '-');
            const status = s.services[svc] || 'unknown';
            document.getElementById('svc-' + svc + '-dot').className =
                'w-2.5 h-2.5 rounded-full ' + svcColor(status);
            document.getElementById('svc-' + svc + '-status').textContent = status;
        }

        // LNbits status card is updated by its own poller (updateLnbitsStatus)

        // Charts
        const labels = data.history.timestamps.map(t => {
            const d = new Date(t);
            return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        });

        cpuChart.data.labels = labels;
        cpuChart.data.datasets[0].data = data.history.cpu;
        cpuChart.update('none');

        ramChart.data.labels = labels;
        ramChart.data.datasets[0].data = data.history.ram;
        ramChart.update('none');

    } catch (e) {
        console.error('Stats fetch failed:', e);
    }
}

// Initial fetch + poll every 10s
fetchStats();
setInterval(fetchStats, 10000);

// ── LNbits HTTP Status Polling (every 2s) ─────────────────────
async function updateLnbitsStatus() {
    const statusDot = document.getElementById('lnbits-status-dot');
    const statusText = document.getElementById('lnbits-status-text');
    const statusBadge = document.getElementById('lnbits-status-badge');
    const statusCard = document.getElementById('lnbits-status-card');
    const openLink = document.getElementById('lnbits-open-link');

    try {
        const resp = await fetch('/box/api/lnbits-status');
        if (!resp.ok) return;
        const data = await resp.json();

        if (data.status === 'running') {
            statusDot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse transition-colors duration-300';
            statusText.textContent = 'LNbits is running';
            statusText.className = 'text-emerald-400/70 text-sm transition-colors duration-300';
            statusBadge.textContent = 'running';
            statusBadge.className = 'text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300 text-emerald-400 border-emerald-400/30 bg-emerald-400/5';
            statusCard.className = 'bg-ln-surface border border-emerald-400/20 rounded-xl p-4 mb-6 transition-all duration-500';
            openLink.classList.remove('opacity-50', 'pointer-events-none');
        } else if (data.status === 'starting') {
            statusDot.className = 'w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse transition-colors duration-300';
            statusText.textContent = 'LNbits is starting...';
            statusText.className = 'text-amber-400/70 text-sm transition-colors duration-300';
            statusBadge.textContent = 'starting';
            statusBadge.className = 'text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300 text-amber-400 border-amber-400/30 bg-amber-400/5';
            statusCard.className = 'bg-ln-surface border border-amber-400/20 rounded-xl p-4 mb-6 transition-all duration-500';
            openLink.classList.add('opacity-50', 'pointer-events-none');
        } else {
            statusDot.className = 'w-2.5 h-2.5 rounded-full bg-red-400 transition-colors duration-300';
            statusText.textContent = data.status === 'error' ? 'LNbits error (HTTP ' + data.code + ')' : 'LNbits is stopped';
            statusText.className = 'text-red-400/70 text-sm transition-colors duration-300';
            statusBadge.textContent = data.status;
            statusBadge.className = 'text-xs font-mono uppercase tracking-wider px-2 py-0.5 rounded-full border transition-all duration-300 text-red-400 border-red-400/30 bg-red-400/5';
            statusCard.className = 'bg-ln-surface border border-red-400/20 rounded-xl p-4 mb-6 transition-all duration-500';
            openLink.classList.add('opacity-50', 'pointer-events-none');
        }
    } catch (e) {
        console.error('LNbits status check failed:', e);
    }
}

updateLnbitsStatus();
setInterval(updateLnbitsStatus, 2000);

// ── Actions ────────────────────────────────────────────────────
let pendingAction = null;

function confirmAction(action, message) {
    pendingAction = action;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-modal').classList.remove('hidden');
    document.getElementById('confirm-btn').onclick = () => executeAction(action);
}

function closeModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
    pendingAction = null;
}

async function executeAction(action) {
    closeModal();
    try {
        const resp = await fetch('/box/api/' + action, { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
            // Show brief feedback
            const msg = action === 'shutdown' ? 'Shutting down...' :
                        action === 'reboot' ? 'Rebooting...' : data.message;
            alert(msg);
        } else {
            alert('Error: ' + data.message);
        }
    } catch (e) {
        alert('Request failed');
    }
}

async function copyOnion() {
    const addr = document.getElementById('stat-tor-address').textContent;
    if (!addr || addr === '--' || addr.startsWith('Waiting')) return;
    try {
        await navigator.clipboard.writeText('http://' + addr);
        const btn = document.getElementById('tor-copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
    } catch (e) {
        // Fallback for non-HTTPS contexts
        const ta = document.createElement('textarea');
        ta.value = 'http://' + addr;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const btn = document.getElementById('tor-copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
    }
}

async function restartService(service) {
    if (!confirm('Restart ' + service + '?')) return;
    try {
        const resp = await fetch('/box/api/restart/' + service, { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
            // Refresh stats after restart
            setTimeout(fetchStats, 2000);
        } else {
            alert('Error: ' + data.message);
        }
    } catch (e) {
        alert('Request failed');
    }
}

// ── System Update ──────────────────────────────────────────────
let updateReleaseTag = '';
let updatePollInterval = null;
let updateReconnectInterval = null;

function showUpdateSection(id) {
    for (const s of ['update-idle', 'update-available', 'update-progress', 'update-done']) {
        document.getElementById(s).classList.toggle('hidden', s !== id);
    }
}

async function checkForUpdate() {
    const btn = document.getElementById('update-check-btn');
    const status = document.getElementById('update-check-status');
    btn.disabled = true;
    status.textContent = 'Checking...';

    try {
        const resp = await fetch('/box/api/update/check');
        if (!resp.ok) { status.textContent = 'Check failed'; btn.disabled = false; return; }
        const data = await resp.json();

        document.getElementById('update-current-version').textContent = 'v' + data.current_version;

        if (data.update_available) {
            updateReleaseTag = data.release_tag;
            document.getElementById('update-latest-version').textContent = 'v' + data.latest_version;
            document.getElementById('update-release-notes').textContent = data.release_notes || 'No release notes.';
            showUpdateSection('update-available');
        } else {
            status.textContent = 'Up to date';
            setTimeout(() => { status.textContent = ''; }, 3000);
        }
    } catch (e) {
        status.textContent = 'Check failed';
    }
    btn.disabled = false;
}

function confirmUpdate() {
    document.getElementById('confirm-message').textContent =
        'This will download and activate a new system version. Services will briefly restart.';
    document.getElementById('confirm-title').textContent = 'Start System Update?';
    document.getElementById('confirm-modal').classList.remove('hidden');
    document.getElementById('confirm-btn').onclick = () => { closeModal(); startUpdate(); };
}

async function startUpdate() {
    showUpdateSection('update-progress');
    document.getElementById('update-log').textContent = '';
    document.getElementById('update-progress-status').textContent = 'Starting update...';

    try {
        const resp = await fetch('/box/api/update/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ release_tag: updateReleaseTag }),
        });
        const data = await resp.json();
        if (data.status !== 'started') {
            document.getElementById('update-progress-status').textContent = 'Error: ' + (data.message || 'Unknown');
            return;
        }
    } catch (e) {
        document.getElementById('update-progress-status').textContent = 'Failed to start update';
        return;
    }

    // Start polling for status
    pollUpdateStatus();
    updatePollInterval = setInterval(pollUpdateStatus, 2000);
}

async function pollUpdateStatus() {
    try {
        const resp = await fetch('/box/api/update/status');
        if (!resp.ok) throw new Error('status fetch failed');
        const data = await resp.json();

        const logEl = document.getElementById('update-log');
        if (data.log_lines && data.log_lines.length > 0) {
            logEl.textContent = data.log_lines.join('\n');
            logEl.scrollTop = logEl.scrollHeight;
        }

        const statusLabels = {
            idle: 'Waiting...',
            downloading: 'Downloading updates...',
            activating: 'Activating new system...',
        };

        if (data.status === 'success') {
            clearInterval(updatePollInterval);
            updatePollInterval = null;
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
            document.getElementById('update-done-text').textContent = 'Update complete! Services have been restarted.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-emerald-400';
            showUpdateSection('update-done');
            // Refresh version display
            setTimeout(checkForUpdate, 5000);
        } else if (data.status === 'failed') {
            clearInterval(updatePollInterval);
            updatePollInterval = null;
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
            document.getElementById('update-done-text').textContent = 'Update failed. Check logs above for details.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-red-400';
            showUpdateSection('update-done');
        } else {
            document.getElementById('update-progress-status').textContent =
                statusLabels[data.status] || data.status;
        }
    } catch (e) {
        // Connection lost — admin app may be restarting during switch-to-configuration
        document.getElementById('update-progress-status').textContent =
            'Reconnecting... (services restarting)';
        startReconnect();
    }
}

function startReconnect() {
    if (updateReconnectInterval) return;
    clearInterval(updatePollInterval);
    updatePollInterval = null;

    updateReconnectInterval = setInterval(async () => {
        try {
            const resp = await fetch('/box/api/update/status');
            if (resp.ok) {
                clearInterval(updateReconnectInterval);
                updateReconnectInterval = null;
                // Resuming — poll once immediately then start regular interval
                pollUpdateStatus();
                updatePollInterval = setInterval(pollUpdateStatus, 2000);
            }
        } catch (e) {
            // Still disconnected, keep trying
        }
    }, 3000);
}

// On page load, check update status in case an update was already in progress
(async function initUpdateCard() {
    try {
        const resp = await fetch('/box/api/update/status');
        if (!resp.ok) return;
        const data = await resp.json();

        if (data.status === 'downloading' || data.status === 'activating') {
            showUpdateSection('update-progress');
            pollUpdateStatus();
            updatePollInterval = setInterval(pollUpdateStatus, 2000);
        } else if (data.status === 'success') {
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-emerald-400';
            document.getElementById('update-done-text').textContent = 'Last update completed successfully.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-emerald-400';
            showUpdateSection('update-done');
        } else if (data.status === 'failed') {
            document.getElementById('update-done-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
            document.getElementById('update-done-text').textContent = 'Last update failed.';
            document.getElementById('update-done-text').className = 'text-sm font-mono text-red-400';
            showUpdateSection('update-done');
        }
    } catch (e) {
        // Ignore — card stays in idle state
    }

    // Load current version
    try {
        const resp = await fetch('/box/api/update/check');
        if (resp.ok) {
            const data = await resp.json();
            document.getElementById('update-current-version').textContent = 'v' + data.current_version;
        }
    } catch (e) {}
})();
</script>
{% endblock %}
