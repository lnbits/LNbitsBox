<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNbitsBox - Trust Root CA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ln-pink': '#FF1EE6',
                        'ln-pink-dim': '#cc18b8',
                        'ln-surface': '#0f0f14',
                        'ln-card': '#16161e',
                        'ln-card-hover': '#1c1c26',
                        'ln-border': '#2a2a3a',
                        'ln-text': '#e4e4ef',
                        'ln-muted': '#7a7a8e',
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    animation: {
                        'glow-pulse': 'glow-pulse 3s ease-in-out infinite',
                        'slide-up': 'slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fade-in 0.6s ease forwards',
                    },
                    keyframes: {
                        'glow-pulse': {
                            '0%, 100%': { opacity: '0.4' },
                            '50%': { opacity: '0.8' },
                        },
                        'slide-up': {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Space Grotesk', sans-serif; }

        .noise-bg::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        .glow-pink {
            box-shadow: 0 0 30px rgba(255, 30, 230, 0.15), 0 0 60px rgba(255, 30, 230, 0.05);
        }

        .glow-pink-strong {
            box-shadow: 0 0 20px rgba(255, 30, 230, 0.3), 0 0 50px rgba(255, 30, 230, 0.1);
        }

        .grid-bg {
            background-image:
                linear-gradient(rgba(255, 30, 230, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 30, 230, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f14; }
        ::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF1EE6; }

        details summary { cursor: pointer; list-style: none; }
        details summary::-webkit-details-marker { display: none; }
        details summary::marker { display: none; }

        details[open] summary .chevron { transform: rotate(180deg); }
        .chevron { transition: transform 0.2s ease; }
    </style>
</head>
<body class="bg-ln-surface text-ln-text min-h-screen noise-bg grid-bg flex items-center justify-center p-4 sm:p-6">

    <div class="relative z-10 w-full max-w-lg">

        <!-- Logo -->
        <div class="flex items-center justify-center gap-3 mb-8 animate-fade-in">
            <svg class="h-8 opacity-90" viewBox="0 0 496 148" xmlns="http://www.w3.org/2000/svg">
                <g fill="none" fill-rule="evenodd">
                    <path d="M168.595 119V99.05h-51.3V15.95H95.245V119h73.35zm31.5 0V52.4l49.8 66.6h22.05V15.95h-22.05v66.6l-49.8-66.6h-22.05V119h22.05zm121.4 1.8c6.7 0 12.775-1.725 18.225-5.175 5.45-3.45 9.725-8.275 12.825-14.475 3.1-6.2 4.65-13.2 4.65-21 0-7.8-1.55-14.775-4.65-20.925-3.1-6.15-7.375-10.95-12.825-14.4-5.45-3.45-11.525-5.175-18.225-5.175-6.1 0-11.575 1.425-16.425 4.275-4.85 2.85-8.775 6.875-11.775 12.075V14.15h-11.25V119h11.25v-14.55c3 5.2 6.925 9.225 11.775 12.075 4.85 2.85 10.325 4.275 16.425 4.275zm-2.1-10.05c-5 0-9.5-1.3-13.5-3.9-4-2.6-7.1-6.225-9.3-10.875-2.2-4.65-3.3-9.925-3.3-15.825 0-5.9 1.1-11.15 3.3-15.75 2.2-4.6 5.3-8.2 9.3-10.8 4-2.6 8.5-3.9 13.5-3.9s8.975 1.3 12.925 3.9c3.95 2.6 7.025 6.2 9.225 10.8 2.2 4.6 3.3 9.85 3.3 15.75 0 5.9-1.1 11.175-3.3 15.825-2.2 4.65-5.275 8.275-9.225 10.875-3.95 2.6-8.475 3.9-12.925 3.9zm49.45-83.4c2 0 3.725-.75 5.175-2.25 1.45-1.5 2.175-3.25 2.175-5.25 0-2-0.725-3.725-2.175-5.175-1.45-1.45-3.175-2.175-5.175-2.175-2.1 0-3.875.725-5.325 2.175-1.45 1.45-2.175 3.175-2.175 5.175 0 2 .725 3.75 2.175 5.25 1.45 1.5 3.225 2.25 5.325 2.25zM374.395 119V41.45h-11.25V119h11.25zm41.1 1.8c5.4 0 10.2-1.65 14.4-4.95l-5.55-8.25c-.9.9-2.05 1.65-3.45 2.25-1.4.6-2.95.9-4.65.9-2.3 0-4.275-.925-5.925-2.775-1.65-1.85-2.475-4.175-2.475-6.975V51.5h19.05v-10.05h-19.05V20.15h-11.25v21.3h-12.15v10.05h12.15V101c0 5.8 1.775 10.55 5.325 14.25 3.55 3.7 8.075 5.55 13.575 5.55zm51.2 0c8.2 0 14.975-2.15 20.325-6.45 5.35-4.3 8.025-9.95 8.025-16.95 0-4.6-1.15-8.325-3.45-11.175-2.3-2.85-5.15-5.075-8.55-6.675-3.4-1.6-7.85-3.25-13.35-4.95-5.6-1.8-9.7-3.25-12.3-4.35-2.6-1.1-4.55-2.35-5.85-3.75-1.3-1.4-1.95-3.2-1.95-5.4 0-3.6 1.5-6.4 4.5-8.4 3-2 6.8-3 11.4-3 7.2 0 14.65 2.45 22.35 7.35l5.4-8.7c-4.2-2.7-8.7-4.825-13.5-6.375-4.8-1.55-9.55-2.325-14.25-2.325-7.9 0-14.4 2.075-19.5 6.225-5.1 4.15-7.65 9.675-7.65 16.575 0 5.5 1.95 9.875 5.85 13.125 3.9 3.25 10.6 6.225 20.1 8.925 4.5 1.3 8.025 2.45 10.575 3.45 2.55 1 4.675 2.375 6.375 4.125 1.7 1.75 2.55 3.925 2.55 6.525 0 3.7-1.575 6.65-4.725 8.85-3.15 2.2-7.275 3.3-12.375 3.3-8.6 0-17.35-3.25-26.25-9.75l-5.85 8.25c4.6 3.7 9.725 6.55 15.375 8.55 5.65 2 11.225 3 16.725 3z" fill="#FFF"/>
                    <polygon fill="#FF1EE6" points="31.763 0 7.108 78.859 26.979 78.859 0 148 74.84 57.352 43.935 57.352 84.304 0"/>
                </g>
            </svg>
        </div>

        <!-- Main Card -->
        <div class="bg-ln-card border border-ln-border rounded-2xl overflow-hidden glow-pink animate-slide-up" style="animation-delay: 0.1s; opacity: 0;">
            <div class="p-6 sm:p-8">

                <!-- State A: Trust Your Root CA -->
                <div id="state-untrusted">
                    <!-- Icon -->
                    <div class="flex justify-center mb-5">
                        <div class="w-16 h-16 rounded-full bg-ln-pink/10 border border-ln-pink/30 flex items-center justify-center">
                            <svg class="w-8 h-8 text-ln-pink" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
                            </svg>
                        </div>
                    </div>

                    <h1 class="text-2xl sm:text-3xl font-bold text-center mb-2 font-display">Trust Your Root CA</h1>
                    <p class="text-ln-muted text-center text-sm mb-6">
                        LNbitsBox uses HTTPS with a local Root CA. Install the certificate to connect securely without browser warnings.
                    </p>

                    <!-- Steps -->
                    <div class="space-y-4">

                        <!-- Step 1: Download -->
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-ln-pink text-white text-sm font-bold flex items-center justify-center step-active">1</div>
                            <div class="flex-1 pt-0.5">
                                <p class="font-medium mb-2">Download the Root CA certificate</p>
                                <a href="/cert/download"
                                   class="inline-flex items-center gap-2 px-4 py-2 bg-ln-pink hover:bg-ln-pink-dim text-white text-sm font-semibold rounded-lg transition-all duration-200 hover:shadow-[0_0_30px_rgba(255,30,230,0.3)]">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
                                    </svg>
                                    Download CA Certificate
                                </a>
                            </div>
                        </div>

                        <!-- Step 2: Install -->
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-ln-border text-ln-muted text-sm font-bold flex items-center justify-center">2</div>
                            <div class="flex-1 pt-0.5">
                                <p class="font-medium mb-2">Install and trust the certificate</p>

                                <!-- macOS -->
                                <details class="mb-2 border border-ln-border rounded-lg overflow-hidden">
                                    <summary class="flex items-center justify-between px-4 py-2.5 bg-ln-surface hover:bg-ln-card-hover transition-colors text-sm">
                                        <span class="font-mono text-ln-text">macOS</span>
                                        <svg class="w-4 h-4 text-ln-muted chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                                    </summary>
                                    <div class="px-4 py-3 text-sm text-ln-muted space-y-1 border-t border-ln-border bg-ln-card">
                                        <p>1. Open the downloaded <code class="font-mono text-ln-text bg-ln-surface px-1 rounded">LNbitsBox-CA.crt</code> file</p>
                                        <p>2. Keychain Access will open &mdash; add it to <strong class="text-ln-text">System</strong> keychain</p>
                                        <p>3. Double-click the certificate, expand <strong class="text-ln-text">Trust</strong></p>
                                        <p>4. Set "When using this certificate" to <strong class="text-ln-text">Always Trust</strong></p>
                                        <p>5. Close and enter your password to confirm</p>
                                    </div>
                                </details>

                                <!-- Windows -->
                                <details class="mb-2 border border-ln-border rounded-lg overflow-hidden">
                                    <summary class="flex items-center justify-between px-4 py-2.5 bg-ln-surface hover:bg-ln-card-hover transition-colors text-sm">
                                        <span class="font-mono text-ln-text">Windows</span>
                                        <svg class="w-4 h-4 text-ln-muted chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                                    </summary>
                                    <div class="px-4 py-3 text-sm text-ln-muted space-y-1 border-t border-ln-border bg-ln-card">
                                        <p>1. Double-click the downloaded <code class="font-mono text-ln-text bg-ln-surface px-1 rounded">LNbitsBox-CA.crt</code> file</p>
                                        <p>2. Click <strong class="text-ln-text">Install Certificate...</strong></p>
                                        <p>3. Select <strong class="text-ln-text">Local Machine</strong>, click Next</p>
                                        <p>4. Choose <strong class="text-ln-text">"Place all certificates in the following store"</strong></p>
                                        <p>5. Browse and select <strong class="text-ln-text">Trusted Root Certification Authorities</strong></p>
                                        <p>6. Click Next, then Finish</p>
                                    </div>
                                </details>

                                <!-- Linux -->
                                <details class="mb-2 border border-ln-border rounded-lg overflow-hidden">
                                    <summary class="flex items-center justify-between px-4 py-2.5 bg-ln-surface hover:bg-ln-card-hover transition-colors text-sm">
                                        <span class="font-mono text-ln-text">Linux</span>
                                        <svg class="w-4 h-4 text-ln-muted chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                                    </summary>
                                    <div class="px-4 py-3 text-sm text-ln-muted space-y-1 border-t border-ln-border bg-ln-card">
                                        <p class="font-mono text-xs text-ln-text bg-ln-surface px-3 py-2 rounded">sudo cp LNbitsBox-CA.crt /usr/local/share/ca-certificates/<br>sudo update-ca-certificates</p>
                                        <p class="mt-2">Then restart your browser.</p>
                                    </div>
                                </details>

                                <!-- iOS -->
                                <details class="mb-2 border border-ln-border rounded-lg overflow-hidden">
                                    <summary class="flex items-center justify-between px-4 py-2.5 bg-ln-surface hover:bg-ln-card-hover transition-colors text-sm">
                                        <span class="font-mono text-ln-text">iOS</span>
                                        <svg class="w-4 h-4 text-ln-muted chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                                    </summary>
                                    <div class="px-4 py-3 text-sm text-ln-muted space-y-1 border-t border-ln-border bg-ln-card">
                                        <p>1. Tap the download link in Safari</p>
                                        <p>2. Go to <strong class="text-ln-text">Settings &rarr; General &rarr; VPN & Device Management</strong></p>
                                        <p>3. Tap the <strong class="text-ln-text">LNbitsBox Root CA</strong> profile and install it</p>
                                        <p>4. Go to <strong class="text-ln-text">Settings &rarr; General &rarr; About &rarr; Certificate Trust Settings</strong></p>
                                        <p>5. Enable full trust for <strong class="text-ln-text">LNbitsBox Root CA</strong></p>
                                    </div>
                                </details>

                                <!-- Android -->
                                <details class="mb-2 border border-ln-border rounded-lg overflow-hidden">
                                    <summary class="flex items-center justify-between px-4 py-2.5 bg-ln-surface hover:bg-ln-card-hover transition-colors text-sm">
                                        <span class="font-mono text-ln-text">Android</span>
                                        <svg class="w-4 h-4 text-ln-muted chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                                    </summary>
                                    <div class="px-4 py-3 text-sm text-ln-muted space-y-1 border-t border-ln-border bg-ln-card">
                                        <p>1. Download the certificate file</p>
                                        <p>2. Go to <strong class="text-ln-text">Settings &rarr; Security &rarr; Encryption & credentials</strong></p>
                                        <p>3. Tap <strong class="text-ln-text">Install a certificate &rarr; CA certificate</strong></p>
                                        <p>4. Select the downloaded file and confirm</p>
                                    </div>
                                </details>

                                <!-- Firefox -->
                                <details class="border border-ln-border rounded-lg overflow-hidden">
                                    <summary class="flex items-center justify-between px-4 py-2.5 bg-ln-surface hover:bg-ln-card-hover transition-colors text-sm">
                                        <span class="font-mono text-ln-text">Firefox (all platforms)</span>
                                        <svg class="w-4 h-4 text-ln-muted chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                                    </summary>
                                    <div class="px-4 py-3 text-sm text-ln-muted space-y-1 border-t border-ln-border bg-ln-card">
                                        <p>Firefox uses its own certificate store:</p>
                                        <p>1. Open <strong class="text-ln-text">Settings &rarr; Privacy & Security &rarr; Certificates</strong></p>
                                        <p>2. Click <strong class="text-ln-text">View Certificates &rarr; Authorities &rarr; Import</strong></p>
                                        <p>3. Select the downloaded file</p>
                                        <p>4. Check <strong class="text-ln-text">"Trust this CA to identify websites"</strong></p>
                                    </div>
                                </details>
                            </div>
                        </div>

                        <!-- Step 3: Verify -->
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-ln-border text-ln-muted text-sm font-bold flex items-center justify-center">3</div>
                            <div class="flex-1 pt-0.5">
                                <p class="font-medium">Verify the connection</p>
                                <p class="text-ln-muted text-sm mt-1">
                                    After installing the certificate, this page will automatically detect the trusted connection and redirect you.
                                </p>
                                <div id="checking-status" class="hidden mt-3 flex items-center gap-2 text-sm text-ln-muted">
                                    <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>Checking HTTPS connection...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skip link -->
                    <div class="mt-6 pt-4 border-t border-ln-border text-center">
                        <a id="skip-link" href="#" class="text-ln-muted text-xs font-mono hover:text-ln-text transition-colors">
                            SKIP (not recommended) &rarr;
                        </a>
                    </div>
                </div>

                <!-- State B: Root CA Trusted -->
                <div id="state-trusted" class="hidden">
                    <!-- Icon -->
                    <div class="flex justify-center mb-5">
                        <div class="w-16 h-16 rounded-full bg-emerald-500/10 border border-emerald-500/30 flex items-center justify-center">
                            <svg class="w-8 h-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/>
                            </svg>
                        </div>
                    </div>

                    <h1 class="text-2xl sm:text-3xl font-bold text-center mb-2 font-display text-emerald-400">Root CA Trusted</h1>
                    <p class="text-ln-muted text-center text-sm mb-6">
                        Your device trusts the LNbitsBox certificate. You can now access LNbitsBox securely over HTTPS.
                    </p>

                    <a id="continue-link" href="#"
                       class="block w-full text-center px-6 py-3 bg-ln-pink hover:bg-ln-pink-dim text-white font-semibold rounded-lg transition-all duration-200 hover:shadow-[0_0_30px_rgba(255,30,230,0.3)]">
                        Continue to LNbitsBox
                    </a>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center animate-fade-in" style="animation-delay: 0.3s; opacity: 0;">
            <p class="text-ln-muted text-xs font-mono tracking-wider uppercase">
                LNbitsBox &middot; Powered by LNbits
            </p>
        </div>
    </div>

    <script>
        (function() {
            var httpsBase = 'https://' + window.location.hostname;
            httpsBase += window.location.pathname.replace(/\/?$/, '/');
            var healthUrl = 'https://' + window.location.hostname + '/health';

            var stateUntrusted = document.getElementById('state-untrusted');
            var stateTrusted = document.getElementById('state-trusted');
            var checkingStatus = document.getElementById('checking-status');
            var skipLink = document.getElementById('skip-link');
            var continueLink = document.getElementById('continue-link');

            skipLink.href = httpsBase;
            continueLink.href = httpsBase;

            var polling = false;

            // Like Start9: make a real fetch to the HTTPS endpoint.
            // If the CA is trusted, TLS handshake succeeds and we get a response.
            // If not trusted, the TLS handshake fails and the promise rejects.
            function checkHttps() {
                if (polling) return;
                polling = true;
                checkingStatus.classList.remove('hidden');

                fetch(healthUrl, { mode: 'no-cors' })
                    .then(function() {
                        showTrusted();
                    })
                    .catch(function() {
                        // TLS handshake failed â€” cert not yet trusted
                        polling = false;
                    });
            }

            function showTrusted() {
                stateUntrusted.classList.add('hidden');
                stateTrusted.classList.remove('hidden');
            }

            // Start polling after a short delay
            setTimeout(function() {
                checkHttps();
                setInterval(function() {
                    if (!polling) checkHttps();
                }, 3000);
            }, 1000);
        })();
    </script>

</body>
</html>
